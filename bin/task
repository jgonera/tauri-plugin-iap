#!/usr/bin/env bash

# See https://github.com/adriancooney/Taskfile

set -euo pipefail

DIR=$(cd "$(dirname "$0")"; pwd)

function default {
  help
}

function help {
  echo "$0 <task> <args>"
  echo "Tasks:"
  compgen -A function | grep -v default | cat -n
}

function llm:build {
  if ! test -z "$(git status --porcelain)"; then
    echo "There are uncommitted changes!"
    exit 1
  fi

  gcloud builds submit \
    llm \
    --config=llm/cloudbuild.yaml \
    --substitutions="SHORT_SHA=$(git rev-parse --short HEAD)"
}

function llm:deploy {
  if ! llm:images | grep "$1" > /dev/null; then
    echo "Image tag $1 not found in repository. Available images:"
    echo
    llm:images
    exit 1
  fi

  gcloud run deploy scribblescan-llm \
    --allow-unauthenticated \
    --cpu 8 \
    --gpu 1 \
    --gpu-type nvidia-l4 \
    --image us-central1-docker.pkg.dev/com-papierlabs/scribblescan/llama.cpp-minicpm-o-2_6-q4_k_m:$1 \
    --max-instances 3 \
    --memory 32Gi \
    --no-cpu-throttling \
    --no-gpu-zonal-redundancy \
    --port 8080 \
    --region us-central1 \
    --service-account scribblescan-llm@com-papierlabs.iam.gserviceaccount.com \
    --timeout=60
}

function llm:images {
  gcloud container images list-tags us-central1-docker.pkg.dev/com-papierlabs/scribblescan/llama.cpp-minicpm-o-2_6-q4_k_m
}

TIMEFORMAT="Task completed in %3lR"
time "${@:-default}"
